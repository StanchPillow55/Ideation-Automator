'use client'; import React,{useEffect,useState} from 'react'; import {Button} from '../../components/ui/button';
const API=process.env.NEXT_PUBLIC_API_URL||'http://localhost:8000'; type Doc={id:string;source_type:string}; type Job={job_id:string;status:string;stages:Record<string,string>;result?:any};
export default function Jobs(){const[D,setD]=useState<Doc[]>([]);const[S,setS]=useState<string[]>([]);const[J,setJ]=useState<Job|null>(null);
const load=async()=>{const r=await fetch(`${API}/v1/sources`);setD(await r.json());}; useEffect(()=>{load();},[]);
const run=async()=>{const r=await fetch(`${API}/v1/pipelines/run`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({source_ids:S,export_options:{}})});setJ(await r.json());};
useEffect(()=>{if(!J)return;const t=setInterval(async()=>{const r=await fetch(`${API}/v1/jobs/${J.job_id}`);const j=await r.json();setJ(j);if(j.status==='completed'||j.status==='failed')clearInterval(t);},1500);return()=>clearInterval(t);},[J?.job_id]);
return(<div className="card"><h2 className="text-xl font-semibold mb-2">Run Pipeline</h2><div className="space-y-2"><div className="space-y-1">{D.map(d=>(<label key={d.id} className="flex items-center gap-2 text-sm"><input type="checkbox" checked={S.includes(d.id)} onChange={e=>setS(p=>e.target.checked?[...p,d.id]:p.filter(x=>x!==d.id))} />{d.id} Â· {d.source_type}</label>))}</div><Button onClick={run}>Start</Button></div>{J&&(<div className="mt-6"><h3 className="font-semibold">Job {J.job_id}</h3><div>Status: <span className="font-mono">{J.status}</span></div><ul className="mt-2 text-sm">{Object.entries(J.stages).map(([k,v])=>(<li key={k}>{k}: {v}</li>))}</ul>{J.status==='completed'&&(<div className="mt-3"><div className="font-semibold">Exports:</div><ul className="text-sm">{Object.entries(J.result?.exports||{}).map(([k,p])=>(<li key={k}><a className="text-blue-600 underline" href={`${API.replace(/\/$/,'')}/exports/${(p as string).split('/').pop()}`} target="_blank">{k}</a></li>))}</ul></div>)}</div>)}</div>);} 
